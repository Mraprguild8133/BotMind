<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Bot - Status Dashboard</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>
                AI Assistant Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/status">API Status</a>
                <a class="nav-link" href="/health">Health Check</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        <h5 class="card-title mb-0">Bot Status Dashboard</h5>
                        <div class="ms-auto">
                            <span class="badge bg-{% if bot_status.status == 'running' %}success{% elif bot_status.status == 'error' %}danger{% else %}warning{% endif %}">
                                {{ bot_status.status.title() }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-clock fa-2x text-info"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Uptime</h6>
                                        <small class="text-muted" id="uptime-display">
                                            Started: {{ bot_status.uptime.strftime('%Y-%m-%d %H:%M UTC') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-comments fa-2x text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Messages</h6>
                                        <span class="h5 mb-0">{{ bot_status.messages_processed }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-images fa-2x text-success"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Images</h6>
                                        <span class="h5 mb-0">{{ bot_status.images_processed }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-3 mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle fa-2x text-{% if bot_status.errors > 0 %}danger{% else %}muted{% endif %}"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Errors</h6>
                                        <span class="h5 mb-0">{{ bot_status.errors }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <small class="text-muted">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Last update: {{ bot_status.last_update.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Services Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="services-status">
                            <!-- Services will be loaded here via JavaScript -->
                            <div class="col-12 text-center">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading services...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fab fa-telegram-plane me-2"></i>
                            Bot Features
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-brain me-2 text-primary"></i>Gemini AI Assistant</h6>
                                <p class="small text-muted mb-0">Advanced conversational AI powered by Google's Gemini model for natural text interactions.</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-eye me-2 text-success"></i>Google Vision Analysis</h6>
                                <p class="small text-muted mb-0">Image analysis including object detection, OCR, landmark recognition, and safety checking.</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-magic me-2 text-warning"></i>Background Removal</h6>
                                <p class="small text-muted mb-0">AI-powered background removal service for photo editing and enhancement.</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6><i class="fas fa-bolt me-2 text-info"></i>Real-time Processing</h6>
                                <p class="small text-muted mb-0">Webhook-based instant message processing with status monitoring and error handling.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-terminal me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshStatus()">
                                <i class="fas fa-sync me-2"></i>Refresh Status
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.open('/status', '_blank')">
                                <i class="fas fa-external-link-alt me-2"></i>API Status
                            </button>
                            <button class="btn btn-outline-success" onclick="window.open('/health', '_blank')">
                                <i class="fas fa-heartbeat me-2"></i>Health Check
                            </button>
                            <button class="btn btn-outline-warning" onclick="setWebhook()">
                                <i class="fas fa-link me-2"></i>Set Webhook
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        {% if bot_status.get('error_message') %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Configuration Error
                    </h6>
                    {{ bot_status.error_message }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>AI Assistant Bot</h6>
                    <p class="small text-muted mb-0">
                        Powered by Gemini AI, Google Vision, and Background.bg
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        <i class="fas fa-server me-1"></i>
                        Status monitoring dashboard
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh status every 30 seconds
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshStatus, 30000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        async function refreshStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                // Update last update time
                const lastUpdateElements = document.querySelectorAll('.text-muted small');
                lastUpdateElements.forEach(el => {
                    if (el.textContent.includes('Last update')) {
                        el.innerHTML = `<i class="fas fa-sync-alt me-1"></i>Last update: ${new Date(data.last_update).toLocaleString()} UTC`;
                    }
                });
                
                // Update counters
                const counters = document.querySelectorAll('.h5');
                if (counters[0]) counters[0].textContent = data.messages_processed;
                if (counters[1]) counters[1].textContent = data.images_processed;
                if (counters[2]) counters[2].textContent = data.errors;
                
                // Update status badge
                const badge = document.querySelector('.badge');
                if (badge) {
                    badge.className = `badge bg-${data.status === 'running' ? 'success' : data.status === 'error' ? 'danger' : 'warning'}`;
                    badge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                }
                
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }
        
        async function loadServicesStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const servicesContainer = document.getElementById('services-status');
                servicesContainer.innerHTML = '';
                
                const services = [
                    { name: 'Telegram Bot', key: 'telegram', icon: 'fab fa-telegram-plane' },
                    { name: 'Gemini AI', key: 'gemini', icon: 'fas fa-brain' },
                    { name: 'Google Vision', key: 'vision', icon: 'fas fa-eye' },
                    { name: 'Background.bg', key: 'background', icon: 'fas fa-magic' }
                ];
                
                services.forEach(service => {
                    const isAvailable = data.services && data.services[service.key];
                    const statusClass = isAvailable ? 'text-success' : 'text-danger';
                    const statusIcon = isAvailable ? 'fas fa-check-circle' : 'fas fa-times-circle';
                    
                    const serviceHtml = `
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="${service.icon} fa-2x text-info"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-0">${service.name}</h6>
                                    <small class="${statusClass}">
                                        <i class="${statusIcon} me-1"></i>
                                        ${isAvailable ? 'Available' : 'Unavailable'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    servicesContainer.innerHTML += serviceHtml;
                });
                
            } catch (error) {
                console.error('Failed to load services status:', error);
                document.getElementById('services-status').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to load services status
                        </div>
                    </div>
                `;
            }
        }
        
        async function setWebhook() {
            try {
                const response = await fetch('/set_webhook', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    alert('Webhook set successfully!');
                } else {
                    alert('Failed to set webhook: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error setting webhook: ' + error.message);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadServicesStatus();
            startAutoRefresh();
            
            // Calculate and display uptime
            const uptimeElement = document.getElementById('uptime-display');
            if (uptimeElement && '{{ bot_status.uptime }}') {
                const startTime = new Date('{{ bot_status.uptime.isoformat() }}');
                const now = new Date();
                const uptime = now - startTime;
                const days = Math.floor(uptime / (1000 * 60 * 60 * 24));
                const hours = Math.floor((uptime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
                
                uptimeElement.innerHTML = `${days}d ${hours}h ${minutes}m`;
            }
        });
        
        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
